#!/bin/ksh

# Check for changes in the file wall rules.
# ARF 1 Sept 2011, 04 January 2019

## clush -w ilium,troy
## clushopt -Lq
## groupby host

export PATH=/usr/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/bin:/sbin

TMPFILE=$(mktemp)
trap '/bin/rm -f "$TMPFILE"' 0

STATUS4=/var/lib/misc/fw4
STATUS6=/var/lib/misc/fw6

iptables-save |
	sed \
		-e '/^# Completed on /d' \
		-e '/^# Generated by iptables-save /d' \
		-e '/^:OUTPUT ACCEPT/d' \
		-e '/^:INPUT ACCEPT/d' \
		-e '/^:FORWARD ACCEPT/d' \
		-e '/^:PREROUTING ACCEPT/d' \
		-e '/^:POSTROUTING ACCEPT/d' \
		> "$TMPFILE"

# Initialisation
[ ! -f "$STATUS4" ] && echo Initialised 4 && cp "$TMPFILE" "$STATUS4"

# Changes
if ! diff "$STATUS4" "$TMPFILE"
then
	cp "$TMPFILE" "$STATUS4"
fi

ip6tables-save |
	sed \
		-e '/^# Completed on /d' \
		-e '/^# Generated by ip6tables-save /d' \
		-e '/^:OUTPUT ACCEPT/d' \
		-e '/^:INPUT ACCEPT/d' \
		-e '/^:FORWARD ACCEPT/d' \
		-e '/^:PREROUTING ACCEPT/d' \
		-e '/^:POSTROUTING ACCEPT/d' \
		> "$TMPFILE"

# Initialisation
[ ! -f "$STATUS6" ] && echo Initialised 6 && cp "$TMPFILE" "$STATUS6"

# Changes
if ! diff "$STATUS6" "$TMPFILE"
then
	cp "$TMPFILE" "$STATUS6"
fi

