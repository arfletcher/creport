#! /bin/ksh

# List information about a host's filesystems, kernel and updates
#

# creport options
##clushopt -Lq
##groupby host

header () { echo; echo "$@"; echo "$@" | sed -e 's/./-/g'; }

: ${quick:=}
if [ "x$1" = "x-q" ]
then
	shift
	quick=1
fi

# NB beware of the wrong verison of perl
# Many of the BIMAS machines have BIMAS' perl in
# /usr/local/bin!

# NB base64 -d requires -i for CentOS 5.

PATH=/usr/bin:/usr/local/sbin:$PATH

# Poor man's paragraph
Paragraph () {
	echo
	LINE=$(echo $@| sed -e 's/./-/g')
	sed -e "1i$*" -e "1i$LINE"
}

echo Host: $(uname -n)
lsb_release -d
echo Uptime: $(uptime | sed -e 's/, *[0-9]* user.*//' -e 's/^.*up //')

#rpm -q kernel | tac | cat -n | egrep $(uname -r) 
ls -t /lib/modules | nl | egrep $(uname -r) | Paragraph Running Kernel

header FSCK Status
# decode and run on remote system
cat <<END | base64 -d -i | sed -e '1a@ARGV=("-vadhS");' | /usr/bin/perl | column -t -s '	'
IyEgL3Vzci9iaW4vcGVybAoKIyBMb29rIGF0IHRoZSBtb3VudGVkIGZpbGUgc3lzdGVtcyBhbmQg
dXNlIHR1bmUyZnMgdG8gZGVkdWNlIHdoZW4gdGhlCiMgbmV4dCBmc2NrIHdpbGwgYmUgZm9yY2Vz
IGF0IGJvb3QgdGltZS4KIwojIC1xCXF1aWV0IC0gZG8gbm90IHByaW50IGluZm8gYWJvdXQgaW5k
aXZpZHVhbCBmaWxlc3lzdGVtcwojIC12CXZlcmJvc2UgLSBwcmludCBpbmZvIGFib3V0IGFsbCBl
eHQ/IGZpbGVzeXN0ZW1zCiMgLXMJcHJpbnQgc3VtbWFyeSBmb3IgdGhlIHdob2xlIG1hY2hpbmUg
b2Ygd2hlbiBuZXh0IGFuIGZzY2sgd2lsbCBvY2N1cgojCiMJCQkJQW50aG9ueSBGbGV0Y2hlciwg
MTAgSmFudWFyeSAyMDExCgp1c2UgNTsKdXNlIHdhcm5pbmdzOwp1c2Ugc3RyaWN0OwoKdXNlIERh
dGE6OkR1bXBlcjsKdXNlIEdldG9wdDo6TG9uZzsKCiMgTG9hZCBvcHRpb25hbCBtb2R1bGVzLiBF
eGl0IGdyYWNlZnVsbHkgaWYgd2UgY2FuJ3QuCm91ciBAbWlzc2luZyA9IGdyZXAoICFldmFsICJ1
c2UgJF87IDEiLCBxdyAoCglEYXRlOjpQYXJzZQoJU3lzOjpGaWxlc3lzdGVtCglUaWU6Okl4SGFz
aAopKSBhbmQgZGllICJQbGVhc2UgaW5zdGFsbCBDUEFOIG1vZHVsZXM6XG4gIGNwYW4gLWkgQG1p
c3NpbmcKb3IgeXVtIC15IGluc3RhbGwgJ3BlcmwoIiwgam9pbigiKScgJ3BlcmwoIiwgQG1pc3Np
bmcpLCAiKSdcbiI7CgojIHl1bSAteSBpbnN0YWxsIHBlcmwtRGF0ZS1QYXJzZSBwZXJsLVN5cy1G
aWxlc3lzdGVtIHBlcmwtVGllLUl4SGFzaAoKdGllIG15ICV1bml0LCAnVGllOjpJeEhhc2gnOwol
dW5pdCA9ICgKCXlyID0+IDM2MDAqMjQqMzY1LAoJbXRoID0+IDM2MDAqMjQqMjkuNSwKCXdrID0+
IDM2MDAqMjQqNywKCWRheSA9PiAzNjAwKjI0LAoJaHIgPT4gMzYwMCwKCW1pbiA9PiA2MCwKCXNl
YyA9PiAxLAopOwoKCm15ICVmbGFnID0gKAoJcXVpZXQJPT4gMCwKCXZlcmJvc2UJPT4gMCwKCXN1
bW1hcnkJPT4gMCwKCWFnZSAJPT4gMCwKCWRldmljZQk9PiAwLAoJaGVhZGVyCT0+IDAsCglzaXpl
CT0+IDAsCik7CgpteSAkVXNhZ2UgPSAiVXNhZ2U6ICQwIFstaF0gWy12XSBbLXFdIFstc10gWy1T
XSBbLWRdXG4iOwomR2V0b3B0OjpMb25nOjpjb25maWcocXcoYnVuZGxpbmcgbm9fYXV0b19hYmJy
ZXYgcmVxdWlyZV9vcmRlciApKTsKR2V0T3B0aW9ucyhcJWZsYWcsIHF3KAogICAgICAgIHF1aWV0
fHEKICAgICAgICB2ZXJib3NlfHYKICAgICAgICBzaXplfFMKICAgICAgICBzdW1tYXJ5fHMKICAg
ICAgICBhZ2V8YQogICAgICAgIGRldmljZXxkCiAgICAgICAgaGVhZGVyfGgKCSksCikgb3IgZGll
ICRVc2FnZTsKCiN1c2UgU3lzOjpGaWxlc3lzdGVtOjpNb3VudFBvaW50ICc6YWxsJzsKCm15ICRm
cyA9IG5ldyBTeXM6OkZpbGVzeXN0ZW07Cm15IEBmaWxlc3lzdGVtcyA9ICRmcy0+ZmlsZXN5c3Rl
bXMoKTsKbXkgJWF1dG9mczsKbXkgJGdsb2JhbCA9ICdOZXZlcic7Cm15ICREQVkgPSAzNjAwKjI0
OwoKIyBDb250cnVjdCB0YWJsZSBoZWFkZXIuCm15ICRoZWFkZXIgPSAnJzsKaWYgKCRmbGFne2hl
YWRlcn0pCnsKCW15IEBoZWFkZXI7CglwdXNoIChAaGVhZGVyLCAnREVWSUNFJykgaWYgJGZsYWd7
ZGV2aWNlfTsKCXB1c2ggKEBoZWFkZXIsICdGUycsICdUWVBFJywgJ05FWFQgQ0hFQ0snKTsKCXB1
c2ggKEBoZWFkZXIsICdMQVNUIENIRUNLRUQnKSBpZiAkZmxhZ3thZ2V9OwoJcHVzaCAoQGhlYWRl
ciwgJ1NJWkUnKSBpZiAkZmxhZ3tzaXplfTsKCXB1c2ggKEBoZWFkZXIsICdVU0VEJykgaWYgJGZs
YWd7c2l6ZX07CgkkaGVhZGVyID0gam9pbigiXHQiLCBAaGVhZGVyKSAuICJcbiI7Cn0KCiNwcmlu
dCBEdW1wZXIoQGZpbGVzeXN0ZW1zKTsKRlM6IGZvciBteSAkZiAoQGZpbGVzeXN0ZW1zKQp7Cgkj
cHJpbnQgIiRmXHQiLCAkZnMtPmZvcm1hdCgkZiksICJcbiI7CglpZiAoJGZzLT5mb3JtYXQoJGYp
IGVxICdhdXRvZnMnKQoJewoJCSRhdXRvZnN7JGZ9ICsrOwoJCW5leHQ7Cgl9CgoJIyBJZ25vcmUg
YXV0b2ZzIG1vdW50ZWQgbG9jYWwgZmlsZXN5c3RlbXMKCWZvciBteSAkYWZzIChrZXlzICVhdXRv
ZnMpCgl7CgkJbmV4dCBGUyBpZiAoJGYgPX4gbSFeJGFmcy8hKTsKCX0KCgkjbmV4dCB1bmxlc3Mg
KCRmID1+IC9leHBvcnQvKTsKCWlmICgkZnMtPmZvcm1hdCgkZikgPX4gL15leHQvKQoJewoKCgkJ
I3ByaW50ICIkZlx0IjsKCQkjcHJpbnQgJGZzLT5mb3JtYXQoJGYpOwoJCSNwcmludCAiXHQiOwoJ
CSNwcmludCAkZnMtPmRldmljZSgkZik7CgkJI3ByaW50ICJcdCI7CgkJI3ByaW50ICRmcy0+Y2hl
Y2tfZnJlcXVlbmN5KCRmKTsKCQkjcHJpbnQgIlxuIjsKCgkjTW91bnQgY291bnQ6ICAgICAgICAg
ICAgICAyNgoJI01heGltdW0gbW91bnQgY291bnQ6ICAgICAgMzIKCSNMYXN0IGNoZWNrZWQ6ICAg
ICAgICAgICAgIE1vbiBTZXAgMjggMTM6MjU6NDEgMjAwOQoJI0NoZWNrIGludGVydmFsOiAgICAg
ICAgICAgMTU1NTIwMDAgKDYgbW9udGhzKQoJI05leHQgY2hlY2sgYWZ0ZXI6ICAgICAgICAgU2F0
IE1hciAyNyAxMzoyNTo0MSAyMDEwCgoKCQkob3BlbiAoU1RESU4sICItfCIpIHx8IGV4ZWMgJ3R1
bmUyZnMnLCAnLWwnLCAkZnMtPmRldmljZSgkZikpCgkJCW9yIGRpZSAiQ2Fubm90IGZvcmsgdHVu
ZTJmcyEgKCQhKS5cbiI7CgoJCW15ICROZXh0Q2hlY2tBZnRlciA9ICdOZXZlcic7CgkJbXkgJE1v
dW50Q291bnQgPSAwOwoJCW15ICRNYXhNb3VudENvdW50ID0gMDsKCQlteSAkTGFzdENoZWNrZWQg
PSAtMTsKCQlteSAkQmxvY2tTaXplID0gMTsKCQlteSAlZnJlZTsKCQlteSAlY291bnQ7CgkJbXkg
JXJlc2VydmVkOwoKCQlteSAkb2sgPSAxOwoKCQl3aGlsZSAoPD4pCgkJewoJCQkjcHJpbnQgInR1
bmUyZnM6ICI7IHByaW50OwoKCQkJaWYgKC9VbmFibGUgdG8gcmVzb2x2ZS8pCgkJCXsKCQkJCSRv
ayA9IDA7CgkJCQlwcmludCAiJGZzLT5kZXZpY2UoJGYpXHRCUk9LRU5cbiI7CgkJCX0KCgkJCWNo
b21wOwoKCQkJaWYgKHMvXkxhc3QgY2hlY2tlZDpccysvL2kpCgkJCXsKCQkJCSRMYXN0Q2hlY2tl
ZCA9IHRpbWUoKSAtIHN0cjJ0aW1lKCRfKTsKCQkJfQoJCQlpZiAocy9eTmV4dCBjaGVjayBhZnRl
cjpccysvL2kpCgkJCXsKCQkJCSROZXh0Q2hlY2tBZnRlciA9ICRfOwoJCQkJaWYgKG15ICR0aW1l
ID0gc3RyMnRpbWUoJE5leHRDaGVja0FmdGVyKSkKCQkJCXsKCQkJCQlpZiAoJHRpbWUgPD0gdGlt
ZSgpKQoJCQkJCXsKCQkJCQkJJE5leHRDaGVja0FmdGVyID0gJ05leHQgYm9vdCc7CgkJCQkJfQoJ
CQkJfQoKCQkJfQoJCQllbHNpZiAocy9eTW91bnQgY291bnQ6XHMrLy9pKQoJCQl7CgkJCQkkTW91
bnRDb3VudCA9ICRfICsgMDsKCQkJfQoJCQllbHNpZiAocy9eTWF4aW11bSBtb3VudCBjb3VudDpc
cysvL2kpCgkJCXsKCQkJCSRNYXhNb3VudENvdW50ID0gJF8gKyAwOwoJCQl9CgkJCWVsc2lmIChz
L15CbG9jayBzaXplOlxzKy8vaSkKCQkJewoJCQkJJEJsb2NrU2l6ZSA9ICRfICsgMDsKCQkJfQoJ
CQllbHNpZiAocy9eKFxTKylcc2NvdW50OlxzKy8vaSkKCQkJewoJCQkJJGNvdW50e2xjKCQxKX0g
PSAkXyArIDA7CgkJCX0KCQkJZWxzaWYgKHMvXkZyZWUgKFxTKylzOlxzKy8vaSkKCQkJewoJCQkJ
JGZyZWV7bGMoJDEpfSA9ICRfICsgMDsKCQkJfQoJCQllbHNpZiAocy9eUmVzZXJ2ZWQgKGJsb2Nr
KSBjb3VudDpccysvL2kpCgkJCXsKCQkJCSRyZXNlcnZlZHtsYygkMSl9ID0gJF8gKyAwOwoJCQl9
CgkJfQoJCWNsb3NlIChTVERJTik7CgoJCWlmIChkZWZpbmVkICRNYXhNb3VudENvdW50ICYmICgk
TWF4TW91bnRDb3VudD4wKSAmJiAoJE1heE1vdW50Q291bnQ8JE1vdW50Q291bnQpKQoJCXsKCQkJ
JE5leHRDaGVja0FmdGVyID0gJ05leHQgYm9vdCc7CgkJfQoKCQlpZiAoISRmbGFne3F1aWV0fSBh
bmQgKCRmbGFne3ZlcmJvc2V9IG9yICROZXh0Q2hlY2tBZnRlciBuZSAnTmV2ZXInKSkKCQl7CgkJ
CW15ICRhZ2UgPSAmYWdlKCRMYXN0Q2hlY2tlZCk7CgkJCSRMYXN0Q2hlY2tlZCA9IGludCgkTGFz
dENoZWNrZWQgLyAkREFZKTsKCgkJCXByaW50ICRoZWFkZXI7ICRoZWFkZXIgPSAnJzsKCgkJCXBy
aW50ICRmcy0+ZGV2aWNlKCRmKSwgIlx0IiBpZiAoJGZsYWd7ZGV2aWNlfSk7CgkJCXByaW50ICRm
OwoJCQlwcmludCAiXHQiOwoJCQlwcmludCAkZnMtPmZvcm1hdCgkZik7CgkJCXByaW50ICJcdCI7
CgkJCXByaW50ICROZXh0Q2hlY2tBZnRlcjsKCQkJI3ByaW50ICJcdCRMYXN0Q2hlY2tlZCBkYXki
IC4gKCRMYXN0Q2hlY2tlZD4xPydzJzonJykgLiAiIGFnbyIgaWYgKCRmbGFne2FnZX0pOwoJCQlw
cmludCAiXHQkYWdlIiBpZiAoJGZsYWd7YWdlfSk7CgoJCQlpZiAoJGZsYWd7c2l6ZX0pCgkJCXsK
CQkJCSRCbG9ja1NpemUgLz0gMTAyNCoxMDI0KjEwMjQ7CgoJCQkJaWYgKGV4aXN0cyAkY291bnR7
YmxvY2t9ICYmIGV4aXN0cyAkZnJlZXtibG9ja30gJiYgZXhpc3RzICRyZXNlcnZlZHtibG9ja30p
CgkJCQl7CgkJCQkJI3ByaW50IER1bXBlcihcJWNvdW50KSwgRHVtcGVyKFwlZnJlZSk7CgkJCQkJ
bXkgJHNpemUgPSAkY291bnR7YmxvY2t9ICogJEJsb2NrU2l6ZTsKCQkJCQlteSAkZnJlZSA9ICRm
cmVle2Jsb2NrfSAqICRCbG9ja1NpemU7CgkJCQkJbXkgJHJlc2VydmVkID0gJHJlc2VydmVke2Js
b2NrfSAqICRCbG9ja1NpemU7CgoJCQkJCW15ICR1c2VkID0gJHNpemUgLSAkZnJlZTsKCQkJCQlt
eSAkYXZhaWwgPSAkZnJlZSAtICRyZXNlcnZlZDsKCgkJCQkJbXkgJHVzZWRwYyA9ICRzaXplPjAg
PyBzcHJpbnRmKCclLjFmJSUnLCAxMDAqJHVzZWQvJHNpemUpIDogJy0nOwoJCQkJCSRzaXplID0g
aW50KCRzaXplICsgMC41KTsgIyByb3VuZCB1cC4KCgkJCQkjcHJpbnQgInNpemU9JHNpemUgZnJl
ZT0kZnJlZSBhdmFpbD0kYXZhaWwgdXNlZD0kdXNlZCByZXNlcnZlZD0kcmVzZXJ2ZWQgdXNlZHBj
PSR1c2VkcGNcblxuIjsKCgkJCQkJcHJpbnQgIlx0JHtzaXplfUdCXHQkdXNlZHBjIjsKCQkJCX0K
CQkJCWVsc2UKCQkJCXsKCQkJCQlwcmludCAiXHRNSVNTSU5HXHQiOwoJCQkJfQoJCQl9CgoJCQlw
cmludCAiXG4iOwoJCX0KCgkJaWYgKCRnbG9iYWwgZXEgJ05ldmVyJykKCQl7CgkJCQkkZ2xvYmFs
ID0gJE5leHRDaGVja0FmdGVyOwoJCX0KCQllbHNpZiAoJE5leHRDaGVja0FmdGVyIGVxICdOZXh0
IGJvb3QnKQoJCXsKCQkJCSRnbG9iYWwgPSAkTmV4dENoZWNrQWZ0ZXI7CgkJfQoJCWVsc2lmICgk
Z2xvYmFsIG5lICdOZXh0IGJvb3QnICYmICROZXh0Q2hlY2tBZnRlciBuZSAnTmV2ZXInKQoJCXsK
CQkJCW15ICRuID0gc3RyMnRpbWUoJE5leHRDaGVja0FmdGVyKTsKCQkJCW15ICRnID0gc3RyMnRp
bWUoJGdsb2JhbCk7CgkJCQkjcHJpbnQgImc9JGcgbj0kbiAkTmV4dENoZWNrQWZ0ZXJcbiI7CgoJ
CQkJJGdsb2JhbCA9ICROZXh0Q2hlY2tBZnRlciBpZiAoJGc+JG4pOwoJCX0KCX0KCWVsc2lmICgk
ZnMtPmZvcm1hdCgkZikgZXEgJ3hmcycpCgl7CgkJbXkgJE5leHRDaGVja0FmdGVyID0gIm5ldmVy
IjsgIyBmb3IgeGZzCgoJCXByaW50ICRoZWFkZXI7ICRoZWFkZXIgPSAnJzsKCQlwcmludCAkZnMt
PmRldmljZSgkZiksICJcdCIgaWYgKCRmbGFne2RldmljZX0pOwoJCXByaW50ICRmOwoJCXByaW50
ICJcdCI7CgkJcHJpbnQgJGZzLT5mb3JtYXQoJGYpOwoJCXByaW50ICJcdCI7CgkJcHJpbnQgJE5l
eHRDaGVja0FmdGVyOwoJCXByaW50ICJcbiI7Cgl9Cgp9CgpwcmludCAiXG4iIGlmICghJGZsYWd7
cXVpZXR9KTsKCnByaW50ICJGU0NLOiAkZ2xvYmFsXG4iIGlmICgkZmxhZ3tzdW1tYXJ5fSk7Cgpl
eGl0OwoKc3ViIGFnZQp7CglteSAoJHQpID0gQF87CgoJZm9yIG15ICR1IChrZXlzICV1bml0KQoJ
ewoJCW15ICR4ID0gJHQvJHVuaXR7JHV9OwoJCW5leHQgdW5sZXNzICgkeCA+IDEpOwoJCW15ICRw
bCA9ICgkeCA9PSAxKSA/ICcnIDogJ3MnOwoKCQlyZXR1cm4gc3ByaW50ZiAnJS4xZiAlcyVzJywg
JHgsICR1LCAkcGw7Cgl9CgoJI215ICRlcnIgPSAnJzsKCSNteSAkZGVsdGEgPSBEYXRlQ2FsYygk
dCx0aW1lKCksXCRlcnIpOwoKCSNwcmludCAkZGVsdGE7CgkjcHJpbnQgIiBlcnI9JGVyciIgaWYg
ZGVmaW5lZCAkZXJyOwoJI3ByaW50ICJcbiI7Cn0KCg==
END

if [ -z "$quick" ]
then
	# Security updates
	yum -q list-security  | Paragraph Security Updates

	# Updates
	TMP=$(mktemp)
	yum -q check-update | sed -e '1,/^$/d' | tee $TMP | Paragraph Updates

	# Excluded updates
	yum -q check-update --disableexcludes=all | sed -e '1,/^$/d' | diff - $TMP | sed -n -e 's/^< //p' | Paragraph Excluded Updates
	rm -f $TMP
fi

